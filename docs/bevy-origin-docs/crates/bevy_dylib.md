# bevy_dylib æ¨¡å—æ–‡æ¡£

## æ¦‚è¿°

`bevy_dylib` æ˜¯ Bevy å¼•æ“çš„åŠ¨æ€é“¾æ¥æ¨¡å—ï¼Œä¸“é—¨ç”¨äºåœ¨å¼€å‘è¿‡ç¨‹ä¸­å¼ºåˆ¶å¯ç”¨åŠ¨æ€é“¾æ¥ï¼Œä»¥æ˜¾è‘—æé«˜å¢é‡ç¼–è¯‘çš„é€Ÿåº¦ã€‚è¯¥æ¨¡å—é€šè¿‡å°† Bevy å¼•æ“æ„å»ºä¸ºåŠ¨æ€åº“æ¥å®ç°å¿«é€Ÿçš„å¼€å‘è¿­ä»£ã€‚

### ç‰ˆæœ¬ä¿¡æ¯
- **ç‰ˆæœ¬**: 0.17.0-dev
- **Rust ç‰ˆæœ¬**: 2024 edition
- **è®¸å¯è¯**: MIT OR Apache-2.0

## ä¸»è¦åŠŸèƒ½

### 1. åŠ¨æ€é“¾æ¥æ”¯æŒ
- å¼ºåˆ¶å°† Bevy å¼•æ“ç¼–è¯‘ä¸ºåŠ¨æ€åº“ (dylib)
- å¤§å¹…æå‡å¢é‡ç¼–è¯‘é€Ÿåº¦ï¼Œç‰¹åˆ«é€‚ç”¨äºå¼€å‘é˜¶æ®µ
- é€šè¿‡å‡å°‘é“¾æ¥æ—¶é—´æ¥æ”¹å–„å¼€å‘ä½“éªŒ

### 2. å¼€å‘ä¼˜åŒ–
- ä¸“ä¸ºå¼€å‘ç¯å¢ƒè®¾è®¡ï¼Œä¸æ¨èåœ¨å‘å¸ƒç‰ˆæœ¬ä¸­ä½¿ç”¨
- ç®€åŒ–å¼€å‘è¿‡ç¨‹ä¸­çš„ç¼–è¯‘æµç¨‹
- æä¾›å¤šç§å¯ç”¨æ–¹å¼ä»¥é€‚åº”ä¸åŒçš„å¼€å‘éœ€æ±‚

## æ ¸å¿ƒç»“æ„

### Cargo.toml é…ç½®

```toml
[package]
name = "bevy_dylib"
version = "0.17.0-dev"
edition = "2024"
description = "Force the Bevy Engine to be dynamically linked for faster linking"

[lib]
crate-type = ["dylib"]

[dependencies]
bevy_internal = { path = "../bevy_internal", version = "0.17.0-dev", default-features = false }
```

### åº“æ–‡ä»¶ç»“æ„

```rust
// å¼ºåˆ¶é“¾æ¥ä¸»è¦çš„ bevy crate
#[expect(
    unused_imports,
    clippy::single_component_path_imports,
    reason = "This links the main bevy crate when using dynamic linking"
)]
use bevy_internal;
```

## API ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•ä¸€ï¼šæ¨èæ–¹å¼ - å‘½ä»¤è¡Œå‚æ•°

ä½¿ç”¨ `cargo run` å‘½ä»¤æ—¶æ·»åŠ  `--features bevy/dynamic_linking` æ ‡å¿—ï¼š

```bash
cargo run --features bevy/dynamic_linking
```

**ä¼˜ç‚¹**ï¼š
- ä¸éœ€è¦ä¿®æ”¹é¡¹ç›®æ–‡ä»¶
- æ˜“äºåœ¨å¼€å‘å’Œå‘å¸ƒæ¨¡å¼ä¹‹é—´åˆ‡æ¢
- é¿å…æ„å¤–åœ¨å‘å¸ƒç‰ˆæœ¬ä¸­åŒ…å«åŠ¨æ€é“¾æ¥

### æ–¹æ³•äºŒï¼šCargo.toml é…ç½®ï¼ˆä¸æ¨èï¼‰

åœ¨é¡¹ç›®çš„ `Cargo.toml` æ–‡ä»¶ä¸­æ·»åŠ  `dynamic_linking` ç‰¹æ€§ï¼š

```toml
[dependencies]
bevy = { version = "0.17", features = ["dynamic_linking"] }
```

**ç¼ºç‚¹**ï¼š
- éœ€è¦åœ¨åˆ›å»ºå‘å¸ƒç‰ˆæœ¬æ—¶æ‰‹åŠ¨ç§»é™¤è¯¥ç‰¹æ€§
- å®¹æ˜“å¿˜è®°ç§»é™¤å¯¼è‡´å‘å¸ƒç‰ˆæœ¬åŒ…å«ä¸å¿…è¦çš„æ–‡ä»¶

### æ–¹æ³•ä¸‰ï¼šæ‰‹åŠ¨ä¾èµ–æ–¹å¼

1. åœ¨ `Cargo.toml` ä¸­æ·»åŠ  `bevy_dylib` ä¾èµ–ï¼š

```toml
[dependencies]
# ä»…åœ¨è°ƒè¯•æ¨¡å¼ä¸‹å¯ç”¨
[target.'cfg(debug_assertions)'.dependencies]
bevy_dylib = "0.17"
```

2. åœ¨ `main.rs` ä¸­æ·»åŠ ä½¿ç”¨å£°æ˜ï¼š

```rust
#[allow(unused_imports)]
#[cfg(debug_assertions)]  // ä»…åœ¨è°ƒè¯•æ¨¡å¼ä¸‹å¯ç”¨
use bevy_dylib;

fn main() {
    App::new()
        .add_plugins(DefaultPlugins)
        .run();
}
```

## ä¸å…¶ä»– Bevy æ¨¡å—çš„é›†æˆ

### bevy_internal ä¾èµ–å…³ç³»

`bevy_dylib` ç›´æ¥ä¾èµ–äº `bevy_internal` æ¨¡å—ï¼š

```rust
// é€šè¿‡ use è¯­å¥å¼ºåˆ¶é“¾æ¥ bevy_internal
use bevy_internal;
```

### ç‰¹æ€§ä¼ é€’æœºåˆ¶

å½“å¯ç”¨ `dynamic_linking` ç‰¹æ€§æ—¶ï¼Œä¼šè‡ªåŠ¨ä¼ é€’åˆ°ç›¸å…³æ¨¡å—ï¼š

```toml
# bevy_internal/Cargo.toml ä¸­çš„ç‰¹æ€§é…ç½®
dynamic_linking = ["bevy_diagnostic/dynamic_linking"]
```

### ç¼–è¯‘é…ç½®

åŠ¨æ€é“¾æ¥é…ç½®ä¼šå½±å“ä»¥ä¸‹æ–¹é¢ï¼š
- ç¼–è¯‘è¾“å‡ºä¸º `.dll`/`.so`/`.dylib` æ–‡ä»¶
- è¿è¡Œæ—¶éœ€è¦åŠ¨æ€åº“æ–‡ä»¶
- é“¾æ¥æ—¶é—´æ˜¾è‘—å‡å°‘

## å¸¸è§ä½¿ç”¨åœºæ™¯

### 1. æ—¥å¸¸å¼€å‘

**åœºæ™¯æè¿°**ï¼šå¼€å‘è€…åœ¨ç¼–å†™æ¸¸æˆé€»è¾‘æ—¶éœ€è¦é¢‘ç¹ç¼–è¯‘æµ‹è¯•

**ä½¿ç”¨æ–¹å¼**ï¼š
```bash
# å¼€å‘æ—¶ä½¿ç”¨
cargo run --features bevy/dynamic_linking

# æˆ–è€…è®¾ç½®åˆ«å
alias dev-run="cargo run --features bevy/dynamic_linking"
```

### 2. å¿«é€ŸåŸå‹å¼€å‘

**åœºæ™¯æè¿°**ï¼šå¿«é€ŸéªŒè¯æƒ³æ³•å’ŒåŠŸèƒ½ï¼Œéœ€è¦æå¿«çš„ç¼–è¯‘é€Ÿåº¦

**é…ç½®ç¤ºä¾‹**ï¼š
```toml
# .cargo/config.toml
[alias]
dev = "run --features bevy/dynamic_linking"
fast = "run --features bevy/dynamic_linking --release"
```

### 3. å›¢é˜Ÿåä½œå¼€å‘

**åœºæ™¯æè¿°**ï¼šå›¢é˜Ÿæˆå‘˜éœ€è¦ç»Ÿä¸€çš„å¼€å‘ç¯å¢ƒé…ç½®

**æœ€ä½³å®è·µ**ï¼š
```bash
# é¡¹ç›® README.md ä¸­çš„å¼€å‘æŒ‡å—
## å¼€å‘ç¯å¢ƒå¯åŠ¨
cargo run --features bevy/dynamic_linking

## å‘å¸ƒç‰ˆæœ¬æ„å»º
cargo build --release
```

### 4. CI/CD æµæ°´çº¿

**åœºæ™¯æè¿°**ï¼šåœ¨æŒç»­é›†æˆä¸­åŒºåˆ†å¼€å‘å’Œå‘å¸ƒæ„å»º

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# .github/workflows/ci.yml
- name: Build Development
  run: cargo build --features bevy/dynamic_linking

- name: Build Release
  run: cargo build --release
```

## é‡è¦æ³¨æ„äº‹é¡¹

### âš ï¸ å‘å¸ƒç‰ˆæœ¬è­¦å‘Š

**ç»å¯¹ä¸è¦åœ¨å‘å¸ƒç‰ˆæœ¬ä¸­å¯ç”¨åŠ¨æ€é“¾æ¥ï¼**

åŸå› ï¼š
- éœ€è¦é¢å¤–åˆ†å‘ `libstd.so` å’Œ `libbevy_dylib.so` æ–‡ä»¶
- å¢åŠ å‘å¸ƒåŒ…å¤§å°å’Œå¤æ‚æ€§
- å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶ä¾èµ–é—®é¢˜

### ğŸ“ æœ€ä½³å®è·µ

1. **å¼€å‘é˜¶æ®µ**ï¼š
   ```bash
   cargo run --features bevy/dynamic_linking
   ```

2. **æµ‹è¯•é˜¶æ®µ**ï¼š
   ```bash
   cargo test --features bevy/dynamic_linking
   ```

3. **å‘å¸ƒæ„å»º**ï¼š
   ```bash
   cargo build --release  # ä¸åŒ…å« dynamic_linking
   ```

### ğŸ”§ æ€§èƒ½å½±å“

- **ç¼–è¯‘æ—¶é—´**ï¼šå¤§å¹…å‡å°‘ï¼ˆå¯è¾¾ 50-80% çš„æ”¹å–„ï¼‰
- **è¿è¡Œæ—¶æ€§èƒ½**ï¼šè½»å¾®å½±å“ï¼ˆåŠ¨æ€é“¾æ¥å¼€é”€ï¼‰
- **å†…å­˜ä½¿ç”¨**ï¼šå¯èƒ½ç•¥æœ‰å¢åŠ 

### ğŸ› æ•…éšœæ’é™¤

#### é—®é¢˜ï¼šæ‰¾ä¸åˆ°åŠ¨æ€åº“æ–‡ä»¶
```
error while loading shared libraries: libbevy_dylib.so
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿åœ¨ç›¸åŒç¯å¢ƒä¸‹ç¼–è¯‘å’Œè¿è¡Œ
2. æ£€æŸ¥ `LD_LIBRARY_PATH` ç¯å¢ƒå˜é‡
3. é‡æ–°ç¼–è¯‘é¡¹ç›®

#### é—®é¢˜ï¼šé“¾æ¥é”™è¯¯
```
error: linking failed
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ¸…ç†æ„å»ºç¼“å­˜ï¼š`cargo clean`
2. é‡æ–°ç¼–è¯‘ï¼š`cargo build --features bevy/dynamic_linking`
3. æ£€æŸ¥ç³»ç»ŸåŠ¨æ€é“¾æ¥å™¨é…ç½®

## æŠ€æœ¯å®ç°ç»†èŠ‚

### ç¼–è¯‘ç±»å‹é…ç½®

```toml
[lib]
crate-type = ["dylib"]
```

è¿™ä¸ªé…ç½®å‘Šè¯‰ Rust ç¼–è¯‘å™¨å°†æ­¤ crate ç¼–è¯‘ä¸ºåŠ¨æ€åº“ã€‚

### å¼ºåˆ¶é“¾æ¥æœºåˆ¶

```rust
#[expect(unused_imports, clippy::single_component_path_imports)]
use bevy_internal;
```

é€šè¿‡ `use` è¯­å¥ç¡®ä¿ `bevy_internal` è¢«åŒ…å«åœ¨åŠ¨æ€åº“ä¸­ï¼Œå³ä½¿çœ‹èµ·æ¥æ²¡æœ‰ç›´æ¥ä½¿ç”¨ã€‚

### ç‰¹æ€§ä¼ æ’­

åŠ¨æ€é“¾æ¥ç‰¹æ€§ä¼šé€šè¿‡ä¾èµ–é“¾ä¼ æ’­åˆ°æ‰€æœ‰ç›¸å…³çš„ Bevy æ¨¡å—ï¼Œç¡®ä¿æ•´ä¸ªå¼•æ“ä»¥åŠ¨æ€æ–¹å¼é“¾æ¥ã€‚

## ä¸ Roblox-TS è¿ç§»çš„è€ƒè™‘

åœ¨å°†ä»£ç è¿ç§»åˆ° Roblox ç”Ÿæ€ç³»ç»Ÿæ—¶ï¼Œ`bevy_dylib` çš„æ¦‚å¿µä¸ç›´æ¥é€‚ç”¨ï¼Œå› ä¸ºï¼š

1. **Roblox-TS ç¼–è¯‘**ï¼šTypeScript ç¼–è¯‘ä¸º Luaï¼Œæ²¡æœ‰åŠ¨æ€é“¾æ¥æ¦‚å¿µ
2. **@rbxts/matter ECS**ï¼šä½œä¸º TypeScript æ¨¡å—ç›´æ¥å¯¼å…¥
3. **æ›¿ä»£ä¼˜åŒ–**ï¼šåœ¨ Roblox-TS ä¸­å¯ä»¥è€ƒè™‘ï¼š
   - æ¨¡å—åŒ–ä»£ç ç»“æ„
   - æ‡’åŠ è½½æœºåˆ¶
   - å¢é‡æ›´æ–°ç­–ç•¥

## æ€»ç»“

`bevy_dylib` æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºæå‡å¼€å‘ä½“éªŒè€Œè®¾è®¡çš„å®ç”¨æ¨¡å—ã€‚å®ƒé€šè¿‡å¯ç”¨åŠ¨æ€é“¾æ¥æ˜¾è‘—å‡å°‘äº†ç¼–è¯‘æ—¶é—´ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿæ›´å¿«åœ°è¿­ä»£å’Œæµ‹è¯•ä»£ç ã€‚æ­£ç¡®ä½¿ç”¨è¿™ä¸ªæ¨¡å—å¯ä»¥å¤§å¹…æå‡å¼€å‘æ•ˆç‡ï¼Œä½†å¿…é¡»æ³¨æ„ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ç”¨å®ƒã€‚

**å…³é”®è¦ç‚¹**ï¼š
- âœ… ä»…åœ¨å¼€å‘é˜¶æ®µä½¿ç”¨
- âœ… ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æ–¹å¼å¯ç”¨
- âœ… å®šæœŸæµ‹è¯•å‘å¸ƒç‰ˆæœ¬æ„å»º
- âŒ ä¸è¦åœ¨å‘å¸ƒç‰ˆæœ¬ä¸­åŒ…å«
- âŒ ä¸è¦åœ¨ Cargo.toml ä¸­æ°¸ä¹…å¯ç”¨